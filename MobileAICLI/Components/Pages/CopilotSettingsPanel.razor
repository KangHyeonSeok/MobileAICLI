@using MobileAICLI.Models
@using MobileAICLI.Components.Shared

<div class="modal fade @(IsVisible ? "show" : "")" style="display: @(IsVisible ? "block" : "none");" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ”§ Copilot ì„¤ì • íŒ¨ë„</h5>
                <button type="button" class="btn-close" @onclick="Cancel"></button>
            </div>
            <div class="modal-body">
                @* í”„ë¦¬ì…‹ ë²„íŠ¼ *@
                <div class="mb-4">
                    <label class="form-label fw-bold">ë¹ ë¥¸ ì„¤ì • (í”„ë¦¬ì…‹)</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-success" @onclick="ApplySafePreset">
                            ì•ˆì „ (Safe)
                        </button>
                        <button type="button" class="btn btn-outline-primary" @onclick="ApplyMediumPreset">
                            ì¤‘ê°„ (Medium)
                        </button>
                        <button type="button" class="btn btn-outline-warning" @onclick="ApplyFullPreset">
                            ì „ì²´ (Full) âš ï¸
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        ì•ˆì „: ì½ê¸°ë§Œ í—ˆìš© | ì¤‘ê°„: ë¡œì»¬ ìˆ˜ì • í—ˆìš© (ê¸°ë³¸) | ì „ì²´: ëª¨ë“  ë„êµ¬ í—ˆìš© (ìœ„í—˜)
                    </small>
                </div>

                @* GITHUB_TOKEN ì¸ì¦ ë°©ì‹ *@
                <div class="mb-4">
                    <label class="form-label fw-bold">ğŸ›¡ï¸ GITHUB_TOKEN ì¸ì¦ ë°©ì‹</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tokenMode" id="tokenModeSystem" 
                               checked="@(Settings.TokenMode == GithubTokenMode.System)"
                               @onchange="@(() => Settings.TokenMode = GithubTokenMode.System)">
                        <label class="form-check-label" for="tokenModeSystem">
                            ì‹œìŠ¤í…œ ê°’ ì‚¬ìš© (ê¸°ë³¸)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tokenMode" id="tokenModeCustom"
                               checked="@(Settings.TokenMode == GithubTokenMode.Custom)"
                               @onchange="@(() => Settings.TokenMode = GithubTokenMode.Custom)">
                        <label class="form-check-label" for="tokenModeCustom">
                            ì§ì ‘ ì…ë ¥ (ì•„ë˜ ì…ë ¥ë€ ì‚¬ìš©)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tokenMode" id="tokenModeNone"
                               checked="@(Settings.TokenMode == GithubTokenMode.None)"
                               @onchange="@(() => Settings.TokenMode = GithubTokenMode.None)">
                        <label class="form-check-label" for="tokenModeNone">
                            ë¬´ì‹œ (í† í° ì—†ì´ ì‹¤í–‰)
                        </label>
                    </div>
                    @if (Settings.TokenMode == GithubTokenMode.Custom)
                    {
                        <div class="mt-2">
                            <input type="password" class="form-control" placeholder="GitHub Token ì…ë ¥"
                                   @bind="Settings.TokenValue">
                        </div>
                    }
                </div>

                @* ì‘ì—… ë””ë ‰í† ë¦¬ *@
                <div class="mb-4">
                    <label class="form-label fw-bold">ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬</label>
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="ì˜ˆ: ~/Documents"
                               @bind="Settings.WorkingDirectory">
                        <button class="btn btn-outline-primary" type="button" @onclick="OpenFolderBrowser">
                            <i class="bi bi-folder2-open"></i> ì°¾ì•„ë³´ê¸°
                        </button>
                    </div>
                    <small class="text-muted">
                        ë¹„ì–´ìˆìœ¼ë©´ OSë³„ ê¸°ë³¸ Documents ë””ë ‰í† ë¦¬ ì‚¬ìš©
                    </small>
                </div>

                @* ëª¨ë“  ë„êµ¬ í—ˆìš© (ìœ„í—˜) *@
                <div class="mb-4">
                    <label class="form-label fw-bold text-danger">âš ï¸ ì „ì²´ í—ˆìš© (ìœ„í—˜)</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="allowAll"
                               @bind="Settings.AllowAll">
                        <label class="form-check-label text-danger" for="allowAll">
                            ëª¨ë“  ë„êµ¬ í—ˆìš© (--allow-all-tools)
                        </label>
                    </div>
                    @if (Settings.AllowAll)
                    {
                        <div class="alert alert-danger mt-2 mb-0" role="alert">
                            <strong>âš ï¸ ê²½ê³ :</strong> ëª¨ë“  ë„êµ¬ë¥¼ í—ˆìš©í•˜ë©´ Copilotì´ íŒŒì¼ ì‚­ì œ, ì‹œìŠ¤í…œ ëª…ë ¹ ì‹¤í–‰ ë“±ì„ ìŠ¹ì¸ ì—†ì´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
                        </div>
                    }
                </div>

                @if (!Settings.AllowAll)
                {
                    @* ê°œë³„ ë„êµ¬ ê¶Œí•œ ì„¤ì • *@
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ“ íŒŒì¼ ì‘ì—…</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fileRead" @bind="Settings.FileRead">
                            <label class="form-check-label" for="fileRead">íŒŒì¼ ì½ê¸° (cat, head, tail, less)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fileWrite" @bind="Settings.FileWrite">
                            <label class="form-check-label" for="fileWrite">íŒŒì¼ ì“°ê¸° (write)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-danger" type="checkbox" id="fileDelete" @bind="Settings.FileDelete">
                            <label class="form-check-label text-danger" for="fileDelete">âš ï¸ ìœ„í—˜: íŒŒì¼ ì‚­ì œ (rm)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ”€ Git ì‘ì—…</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="gitStatus" @bind="Settings.GitStatus">
                            <label class="form-check-label" for="gitStatus">Git ìƒíƒœ (status, log, diff)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="gitBranch" @bind="Settings.GitBranch">
                            <label class="form-check-label" for="gitBranch">Git ë¸Œëœì¹˜ (branch, checkout)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="gitCommit" @bind="Settings.GitCommit">
                            <label class="form-check-label" for="gitCommit">Git ì»¤ë°‹ (add, commit)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-warning" type="checkbox" id="gitPush" @bind="Settings.GitPush">
                            <label class="form-check-label text-warning" for="gitPush">âš ï¸ ì›ê²©: Git í‘¸ì‹œ (push)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-danger" type="checkbox" id="gitForce" @bind="Settings.GitForce">
                            <label class="form-check-label text-danger" for="gitForce">âš ï¸ ìœ„í—˜: Git ê°•ì œ (reset)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ”— GitHub PR/Issue</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prRead" @bind="Settings.PrRead">
                            <label class="form-check-label" for="prRead">PR/Issue ì¡°íšŒ (list)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-warning" type="checkbox" id="prWrite" @bind="Settings.PrWrite">
                            <label class="form-check-label text-warning" for="prWrite">âš ï¸ ì›ê²©: PR ìƒì„± (create)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-warning" type="checkbox" id="issueWrite" @bind="Settings.IssueWrite">
                            <label class="form-check-label text-warning" for="issueWrite">âš ï¸ ì›ê²©: Issue ìƒì„± (create)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ’» ì‰˜ ëª…ë ¹</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shellBasic" @bind="Settings.ShellBasic">
                            <label class="form-check-label" for="shellBasic">ê¸°ë³¸ ì‰˜ (ls, pwd, echo, find)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-warning" type="checkbox" id="shellPackage" @bind="Settings.ShellPackage">
                            <label class="form-check-label text-warning" for="shellPackage">âš ï¸ ì£¼ì˜: íŒ¨í‚¤ì§€ ì„¤ì¹˜ (npm, pip, yarn)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input text-danger" type="checkbox" id="shellSystem" @bind="Settings.ShellSystem">
                            <label class="form-check-label text-danger" for="shellSystem">âš ï¸ ìœ„í—˜: ì‹œìŠ¤í…œ ëª…ë ¹ (ëª¨ë“  shell)</label>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Reset">ì´ˆê¸°í™”</button>
                <button type="button" class="btn btn-secondary" @onclick="Cancel">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" @onclick="Save">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

@if (IsVisible)
{
    <div class="modal-backdrop fade show"></div>
}

@* Folder Browser *@
<FolderBrowser IsVisible="showFolderBrowser"
               InitialPath="@Settings.WorkingDirectory"
               OnPathSelected="HandlePathSelected"
               OnCancel="HandleFolderBrowserCancel" />

@code {
    [Parameter]
    public CopilotSettings Settings { get; set; } = new();

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<CopilotSettings> OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private bool showFolderBrowser = false;

    private void OpenFolderBrowser()
    {
        showFolderBrowser = true;
    }

    private Task HandlePathSelected(string path)
    {
        Settings.WorkingDirectory = path;
        showFolderBrowser = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task HandleFolderBrowserCancel()
    {
        showFolderBrowser = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ApplySafePreset()
    {
        Settings.ApplyPreset("safe");
        StateHasChanged();
    }

    private void ApplyMediumPreset()
    {
        Settings.ApplyPreset("medium");
        StateHasChanged();
    }

    private void ApplyFullPreset()
    {
        Settings.ApplyPreset("full");
        StateHasChanged();
    }

    private async Task Save()
    {
        await OnSave.InvokeAsync(Settings);
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }

    private void Reset()
    {
        Settings.ApplyPreset("medium");
        Settings.TokenMode = GithubTokenMode.System;
        Settings.TokenValue = string.Empty;
        Settings.WorkingDirectory = string.Empty;
        StateHasChanged();
    }
}
