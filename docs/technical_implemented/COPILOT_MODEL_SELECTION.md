# Copilot 모델 전환 설계

## 1. 개요
- 웹 UI에서 Copilot CLI가 사용하는 모델을 전환할 수 있도록 하는 설계
- CLI가 지원하는 모델 옵션을 안전하게 전달하고, 현재 설정을 확인/표시하는 흐름 정의
- 사용자 입력 검증과 기본값 관리로 오동작을 방지

## 2. 현재 상태
- `CopilotStreamingService`는 `-p`와 `--silent`, `--add-dir`만 사용하며 모델 선택 옵션 없음
- 모델/프리셋 관련 설정 필드가 `MobileAICLISettings`에 없음
- UI에는 모델 선택 UI가 없고, Hub 호출도 모델 정보 없이 프롬프트만 전달

## 3. 목표
- 지원 가능한 모델 목록(예: 기본, 고성능, 비용 절약형)을 표 형태로 노출하고 선택 가능
- 선택된 모델이 모든 Copilot 호출 경로(스트리밍, explain 등)에 일관되게 반영
- 잘못된 모델 값 입력 시 기본값으로 폴백하고 사용자에게 경고
- 모의 모드(`EnableCopilotMock`)에서도 모델 정보가 UI에 표기되어 동작 여부 확인 가능

## 4. 접근 방법
### 4.1 설정 및 상태 관리
- `MobileAICLISettings`에 `CopilotModel` 기본값 필드를 추가 (예: `default`)
- UI에서 선택된 모델을 서버로 전달할 때는 명시적으로 허용된 리스트에서만 선택하도록 클라이언트 검증
- 서버 측에서도 화이트리스트로 이중 검증하여 임의 문자열 전달을 차단
- 모델 선택은 세션 단위(사용자별) 상태를 유지하고, 환경 설정 기본값을 초기 모델로 사용

### 4.2 CLI 호출 전략
- Copilot CLI가 제공하는 모델 선택 옵션을 사용 (예: `--model <name>` 혹은 공식 문서에 정의된 파라미터)
- 허용된 모델 목록과 CLI 버전 호환성을 `CheckInstallationAsync` 확장으로 점검해, 미지원 옵션이면 경고 반환 후 기본 모델로 실행
- 스트리밍/설명/단발 호출 경로 모두 동일한 인자 빌더를 사용해 모델 옵션을 붙이는 공통 메서드 마련
- CLI 명령(예: `gh copilot` vs `copilot`) 차이에 따라 첫 토큰 외 인자 처리 로직을 재사용

### 4.3 UI 및 Hub 연동
- `Copilot.razor` 또는 별도 설정 패널에 모델 선택 드롭다운 추가, 선택값을 `CopilotHub.SendPrompt` 호출 시 전달
- `CopilotHub`는 `CopilotToolSettings`와 별도로 `model` 파라미터를 추가 수용하도록 확장 (호출 시 null 허용)
- Hub 응답에 현재 적용된 모델을 포함한 상태 DTO를 내려 UI에서 표시 (예: “모델: gpt-4.1-preview”)

### 4.4 유효성 및 예외 처리
- 허용 리스트: 예시로 `default`, `gpt-4.1-preview`, `claude-3.5-sonnet` 등 실제 CLI가 제공하는 명칭만 포함
- 미지원 모델 요청 시: 경고 메시지와 함께 기본값으로 실행하며, 로깅에 원인 기록
- CLI 옵션 오류 발생 시: `CopilotOutput.Complete(false, error)`로 전달하고 UI에서 안내 배너 출력

## 5. 작업 단계
- [ ] 설정: `MobileAICLISettings`에 `CopilotModel`, `AllowedCopilotModels` 추가, appsettings에 기본값 기입
- [ ] 서비스: `CopilotStreamingService`와 `CopilotService`에 공통 인자 빌더 추가, 모델 인자 주입
- [ ] 허브/모델: `CopilotHub` DTO 확장, 모델 파라미터 전달 및 상태 반환
- [ ] UI: 모델 선택 UI 추가 및 허용 리스트 기반 클라이언트 검증
- [ ] 로깅/모니터링: 모델 변경 이벤트와 폴백 발생을 로그로 남기고 상태 패널에 노출
- [ ] 테스트: 허용/비허용 모델, 옵션 미지원 CLI 버전, 모의 모드에서의 표기 동작 검증

## 6. 일정
- 설계/합의: 0.5일
- 설정 및 서비스 수정: 0.5일
- UI/HUB 연동: 0.5일
- 테스트 및 문서화: 0.5일

## 7. 위험 요소
- CLI 버전별 모델 옵션 불일치: 옵션 미지원 시 실패 가능 → 사전 버전 체크와 폴백 필수
- 모델 명칭 변경/폐기: 허용 리스트를 환경설정으로 외부화하여 교체 용이하게 유지
- 사용자 세션 상태 불일치: 서버/클라이언트 모델 상태를 Hub 응답으로 매번 반환해 동기화

## 8. 기술 상세 (접기)
<details>
<summary>개발자용 세부 고려사항</summary>

- CLI 옵션 확인: 최신 Copilot CLI 문서에서 모델 선택 인자와 지원 모델 목록을 주기적으로 업데이트
- 상태 관리: SignalR 호출 시 모델을 함께 보내고, 서버에서 최종 적용 모델을 되돌려 UI 라벨을 갱신
- 다중 호출 일관성: 스트리밍/Explain/CheckStatus 모든 경로가 동일한 모델 선택 로직을 사용해야 함
- 성능 영향: 고성능 모델 선택 시 응답 지연 가능성 안내 문구를 UI에 배치
- 모의 모드: `EnableCopilotMock`일 때도 선택된 모델 이름을 그대로 반환해 UI 흐름을 검증

</details>
