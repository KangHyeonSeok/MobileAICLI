# 작업 경로 변경 설계

## 1. 개요
- 기본 `RepositoryPath`를 동적으로 교체하거나(프로젝트 전환), 교체된 루트 안에서 작업 경로를 전환할 수 있도록 하는 설계
- 파일 조회/편집, 터미널 실행, Copilot 호출이 동일한 “현재 루트 + 현재 작업 경로” 컨텍스트를 공유하도록 정의
- 경로 조작 및 루트 교체로 인한 보안 이슈를 방지하기 위한 검증 체계 수립

## 2. 현재 상태
- 모든 서비스가 설정값 `RepositoryPath`를 작업 디렉터리로 사용하며, 런타임 루트 변경 기능이 없음
- `FileService`는 `Path.GetRelativePath`로 경로 이탈을 차단하지만 루트 교체/멀티 프로젝트 시나리오를 지원하지 않음
- `TerminalService`, `CopilotStreamingService`는 설정된 경로를 그대로 사용하며 입력 경로 검증이 미흡

## 3. 목표
- 세션 단위로 **루트 저장소(기본 RepositoryPath 교체)** 를 선택/변경하고, 그 안에서 현재 작업 디렉터리를 이동할 수 있는 UI/서버 흐름 제공
- 선택된 루트와 작업 경로가 `FileService`, `TerminalService`, `CopilotService` 계열 호출에 일관 적용
- 루트 교체 시에도 경로 이탈(../), 심볼릭 링크 탈출, 존재하지 않는 경로에 대한 방어 로직 유지

## 4. 접근 방법
### 4.1 컨텍스트 관리
- `RepositoryContext`(Scoped)로 **현재 루트**(선택된 저장소 경로)와 **현재 작업 경로**(루트 내부 상대경로)를 함께 관리
- 초기값은 설정 `RepositoryPath`; UI에서 “루트 변경” 요청 시 서버가 새 루트를 검증/허용 후 컨텍스트 업데이트
- SignalR 연결마다 컨텍스트를 분리하여 사용자별/세션별 루트·경로가 독립
	- 기본: **로컬 Git 저장소 여부**를 기준으로 허용 (루트에 `.git` 디렉터리가 있거나 `git rev-parse --is-inside-work-tree` 성공 시 허용)
	- 추가: 환경설정 화이트리스트(`AllowedRepositoryRoots`)나 패턴(예: `/work/*`, `C:\repos\*`)을 병행 적용 가능
	- git 검증 시
		- `ProcessStartInfo`로 `git` 실행, exit code로 판별
		- **타임아웃(예: 2~3초)** 적용, 응답 지연/무한 대기 방지
		- `GitCliPath`(환경변수/설정)로 git 실행 경로 지정 가능, 미설정 시 기본 `git` 사용
		- stderr 메시지는 사용자에겐 최소 노출

### 4.2 루트/경로 검증
- **루트 검증**
	- 입력 루트를 절대경로로 정규화 후, 아래 조건을 모두 만족해야 허용
		1) **Git 저장소 판별**: 루트에 `.git` 폴더 존재 **또는** `git rev-parse --is-inside-work-tree` 성공
		2) (옵션) 허용 패턴/화이트리스트(`AllowedRepositoryRoots`) 일치
		3) 디렉터리가 실제 존재하며 심볼릭 링크가 아님 (또는 링크가 루트 외부를 가리키지 않음)
	- 실패 시 거부하며, “허용되지 않은 루트” 또는 “Git 저장소 아님” 같은 최소 정보만 반환
- **작업 경로 검증**: 루트와 결합한 절대경로를 구한 뒤 `Path.GetRelativePath(root, target)`으로 루트 이탈을 차단
- 심볼릭 링크 처리: `DirectoryInfo.LinkTarget` 확인 또는 `File.GetAttributes` 조합으로 링크 탐지 후 루트 이탈을 일으키는 링크는 거부
- 숨김/특정 디렉터리 정책: `.git`, `bin/`, `obj/` 등은 읽기 전용 또는 차단 정책을 명시해 서비스별로 공통 적용

### 4.3 서비스 적용 지점
- `FileService`: 컨텍스트 기반 “현재 루트 + 현재 경로”로 파일 탐색/읽기/쓰기 수행, 반환 시 상대경로를 항상 **루트 기준**으로 normalize
- `TerminalService`: `WorkingDirectory`를 “현재 루트 + 현재 경로”로 설정, 커맨드 인자에 추가 경로가 있으면 동일 검증 적용
- `CopilotStreamingService`/`CopilotService`: CLI 실행 시 `--add-dir`와 `WorkingDirectory` 모두 컨텍스트 경로 사용
- SignalR Hubs: Hub 메서드에서 **루트 변경 API**와 **작업 경로 변경 API**를 모두 제공, 이후 호출에 컨텍스트 주입

### 4.4 UI 흐름
- 상단/사이드 패널에 “현재 루트” 선택(드롭다운 또는 경로 입력)과 “현재 경로” 표시/변경 입력창 제공
- 루트 변경 시: 허용 목록 안내와 검증 실패 사유(미허용 루트/존재하지 않음/링크 차단) 표시
- 경로 변경 시: 성공/실패 사유를 토스트/배너로 안내
- 파일 브라우저 네비게이션과 동기화: 브라우저 이동 시 컨텍스트 갱신, 터미널/코파일럿 호출도 같은 루트/경로 사용

## 5. 작업 단계
- [ ] `RepositoryContext` 스코프 서비스 추가: **현재 루트 + 현재 경로** 상태, 루트/경로 검증 메서드 포함, 허용 루트 목록 주입
- [ ] 기존 서비스(File, Terminal, Copilot)에서 설정 기반 경로 접근을 컨텍스트 기반으로 교체
- [ ] Hub 메서드에 **루트 변경 API**와 **작업 경로 변경 API** 추가, 모든 호출에 컨텍스트 주입
- [ ] UI: 루트 선택/입력 + 현재 경로 전환 UX 추가, 검증 실패 메시지/허용 루트 안내 표시
- [ ] 보안 검증 강화: 심볼릭 링크 차단, 숨김 디렉터리 접근 정책 정의, 허용 루트 화이트리스트
- [ ] 테스트: 루트 교체, 루트 이탈 시도, 존재하지 않는 경로, 심볼릭 링크, 동시 세션 간 루트/경로 분리 검증

## 6. 일정
- 컨텍스트/검증 설계 및 구현: 0.5일
- 서비스/Hub 적용: 0.5일
- UI 연동: 0.5일
- 테스트/문서화: 0.5일

## 7. 위험 요소
- 경로 검증 누락 시 루트 이탈 가능성 → 모든 진입점에서 공통 검증 사용 강제
- 심볼릭 링크 처리 누락 → 링크를 따라 루트 밖으로 탈출할 수 있음, 링크 탐지/차단 로직 필수
- 세션 간 경로 공유로 의도치 않은 경로 변경 → scoped 컨텍스트로 사용자별 분리

## 8. 기술 상세 (접기)
<details>
<summary>개발자용 세부 고려사항</summary>

- 스코프 수명: Blazor Server는 회선 단위 DI 스코프를 사용하므로 컨텍스트를 Scoped로 등록
- 병렬 요청: 동일 세션에서 병렬 호출 시 경로 읽기/쓰기 동기화 필요 → 경로 변경은 atomic하게 처리
- 파일 반환 포맷: UI에 노출되는 경로는 항상 루트 기준 상대경로로 normalize하여 정보 누출 방지
- CI/테스트: 테스트 프로젝트에서 임시 루트를 사용하고 심볼릭 링크 시나리오를 포함

</details>

## 작업 디렉토리 설정

### 요구사항

1. **UI에서 작업 디렉토리 설정 가능**
   - 설정 패널에 디렉토리 경로 입력 필드 추가
   - 디렉토리 선택 버튼 (가능한 경우)

2. **기본값 설정**
   - 설정된 값이 없으면 OS별 Documents 디렉토리 사용
     - Windows: `%USERPROFILE%\Documents`
     - macOS: `~/Documents`
     - Linux: `~/Documents`

3. **설정 지속성**
   - LocalStorage에 저장하여 브라우저 새로고침 후에도 유지
   - 서버 재시작 시에도 클라이언트 설정 유지

4. **검증**
   - 경로 존재 여부 확인
   - 읽기/쓰기 권한 확인
   - 유효하지 않은 경로 시 경고 표시

### UI 추가 (설정 패널)

```
┌─────────────────────────────────────────────────────────┐
│  📁 작업 디렉토리                                        │
│  ┌────────────────────────────────────────────────────┐ │
│  │ [____________________________] [찾아보기]          │ │
│  │                                                    │ │
│  │ 현재: ~/Documents (기본값)                         │ │
│  │ ✓ 디렉토리 접근 가능                               │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 로직 흐름

```
1. 앱 시작
   ↓
2. LocalStorage에서 저장된 경로 확인
   ↓
3-a. 저장된 경로 있음 → 해당 경로 사용
3-b. 저장된 경로 없음 → OS별 Documents 경로 사용
   ↓
4. 경로 유효성 검증
   ↓
5-a. 유효함 → 정상 사용
5-b. 유효하지 않음 → 경고 표시 + 설정 패널 열기 유도
```

---