# 환경 설정 기능 설계

## 1. 개요
- MobileAICLI의 주요 경로, 명령어, 인증 관련 환경설정을 UI/서버에서 동적으로 관리하는 기능 설계
- 핵심 설정 항목: `GitHubCopilotCommand`, `GitHubCliPath`, `AllowedShellCommands`, `GitCliPath`, 허용 작업 루트(화이트리스트)
- 추가로 앱 비밀번호(인증용) 변경 기능 포함

## 2. 현재 상태
- 모든 설정은 `appsettings.json`에 하드코딩되어 런타임 변경 불가
- 서비스들은 DI로 설정을 주입받아 사용하며, 변경 시 앱 재시작 필요
- 비밀번호는 환경변수로만 관리되고, 변경 UI/엔드포인트 없음

## 3. 목표
- UI에서 주요 환경설정(경로, 명령어, 인증 등)을 조회/수정 가능
- 변경된 설정이 즉시(혹은 최소 재시작) 서비스에 반영됨을 보장
- 설정값 검증(명령어 화이트리스트, 경로 유효성, git 실행 경로 등)과 보안(비밀번호 해시 관리) 강화
- 비밀번호 변경은 기존 비밀번호 검증 후 새 해시로 교체, 환경변수/보안 저장소에 반영

## 4. 접근 방법
### 4.1 설정 항목 관리
- `MobileAICLISettings` 모델에 모든 주요 설정 필드 포함: Copilot/GitHub 명령 경로, shell 명령 화이트리스트, git 경로, 허용 루트 목록
- UI에서 각 항목을 편집할 때 서버에 변경 요청(REST/SignalR) → 서버가 검증 후 설정 파일/환경변수에 반영
- 경로/명령어 입력 시 실시간 유효성 검사(존재 여부, 실행 가능 여부, 위험 명령 차단)
- git 경로는 `GitCliPath`로 별도 관리, 미설정 시 기본 `git` 사용
- 허용 작업 루트는 경로 입력 또는 패턴(예: `/work/*`)으로 관리, UI에서 현재 허용 목록 조회/추가/삭제 가능

### 4.2 비밀번호 변경
- 비밀번호 변경 UI: 기존 비밀번호 입력 → 새 비밀번호 입력 → 서버에서 기존 해시 검증 후 새 해시로 교체
- 해시 교체는 환경변수(`MOBILEAICLI_PASSWORD_HASH`) 또는 보안 저장소에 즉시 반영
- 변경 성공/실패(기존 비밀번호 불일치, 해시 오류 등) 결과를 UI에 안내
- 비밀번호 변경 시 감사 로그 기록, 실패 횟수 제한 및 지연 적용

### 4.3 설정 반영 및 서비스 연동
- 설정 변경 시 서비스에 즉시 반영(옵션: 앱 재시작 안내)
- DI 컨테이너에서 최신 설정을 주입받도록 `IOptionsSnapshot` 또는 동적 리로드 패턴 적용
- 위험 명령어/경로 입력 시 서버에서 거부, UI에 안내
- 설정 변경 내역은 감사 로그로 남기고, 민감 정보(비밀번호, 토큰)는 로그에 남기지 않음

### 4.4 UI/UX
- 환경설정 패널: 각 항목별 입력/수정/저장 버튼, 실시간 유효성 검사 및 결과 안내
- 비밀번호 변경은 별도 섹션/모달로 분리, 입력값 마스킹
- 설정 변경 후 즉시 반영/재시작 안내, 실패 사유(유효성, 권한 등) 명확히 표시

## 5. 작업 단계
- [ ] `MobileAICLISettings` 모델에 모든 항목 추가, 환경변수/설정 파일 파서 확장
- [ ] 환경설정 UI/서버 API(REST/SignalR) 설계 및 구현
- [ ] 비밀번호 변경 UI/엔드포인트, 해시 검증/교체 로직 구현
- [ ] 서비스에서 동적 설정 반영(IOptionsSnapshot 등) 적용
- [ ] 유효성 검사/보안 검증 강화, 감사 로그 추가
- [ ] 테스트: 정상/비정상 입력, 비밀번호 변경, 설정 반영, 실패/성공 케이스

## 6. 일정
- 모델/파서/기본 UI: 0.5일
- 서버 API/비밀번호 변경: 0.5일
- 서비스 연동/테스트: 0.5일
- 문서화/최종 검증: 0.5일

## 7. 위험 요소
- 설정값 오입력(잘못된 경로/명령어) → 실시간 유효성 검사 및 서버 검증 필수
- 비밀번호 변경 실패/해시 오류 → 기존 해시 검증, 실패 횟수 제한, 감사 로그
- 설정 변경 후 서비스 미반영 → 동적 리로드 패턴 적용, 재시작 안내

## 8. 기술 상세 (접기)
<details>
<summary>개발자용 세부 고려사항</summary>

- `IOptionsSnapshot`/`IOptionsMonitor`로 런타임 설정 변경 반영
- 환경변수/설정 파일 동기화: 파일 변경 시 앱 재시작 안내, 환경변수는 즉시 반영
- 비밀번호 해시: PBKDF2/BCrypt/Scrypt 등 반복/솔트 포함 방식, 평문 저장 금지
- git 경로: `GitCliPath` 환경변수/설정값 우선, 미설정 시 기본 `git` 사용
- 허용 루트: 패턴/화이트리스트 병행, git 저장소 여부 검증(4초 타임아웃)
- 감사 로그: 설정 변경/비밀번호 변경 이벤트 기록, 민감 정보 마스킹

</details>
